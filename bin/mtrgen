#!/usr/bin/env php
<?php

declare(strict_types=1);

$root_app = dirname(__DIR__);

if (!is_file($root_app . '/vendor/autoload.php')) {
    $root_app = dirname(__DIR__, 4);
}

require_once $root_app . '/vendor/autoload.php';

use Matronator\Generator\Cli\Application;
use Matronator\Generator\Config\Configurator;
use Matronator\Generator\Entity;
use Matronator\Generator\Facade;
use Matronator\Generator\FileGenerator;
use Matronator\Generator\FormControl;
use Matronator\Generator\Repository;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\SingleCommandApplication;

// $application = new Application;
// $application->app->run();

function command(InputInterface $input, OutputInterface $output)
{
    $type = $input->getOption('type');
    $name = $input->getArgument('name');
    $configFile = $input->getOption('config');

    if ($configFile) {
        $config = new Configurator($configFile);
        $output->writeln('Generating from config: ' . $configFile . '...');
        if (isset($config->model) && $config->model) {
            $modelFiles = $config->generateModel($config->model);
            FileGenerator::writeFile($modelFiles);
        }
        if (isset($config->ui) && $config->ui) {
            $uiFiles = $config->generateUI($config->ui);
            FileGenerator::writeFile($uiFiles);
        }
    } else {
        $files = [];
        if (strtolower($type) == 'facade') {
            $files[] = Facade::generate($name);
        } else if (strtolower($type) == 'repository') {
            $files[] = Repository::generate($name);
        } else if (strtolower($type) == 'entity') {
            $files[] = Entity::generate($name);
        } else if (strtolower($type) == 'control') {
            $files[] = FormControl::generate($name);
        } else if (strtolower($type) == 'database') {
            $files[] = Repository::generate($name);
            $files[] = Entity::generate($name);
            $files[] = Facade::generate($name);
        }

        FileGenerator::writeFile($files);
    }

    $output->writeln('Generated!');
}

(new SingleCommandApplication())
    ->setName('File Generator')
    ->addOption(
        'type', 't',
        InputOption::VALUE_OPTIONAL,
        'Entity type',
        'database'
    )
    ->addOption(
        'config', 'c',
        InputOption::VALUE_OPTIONAL,
        'Path to config file'
    )
    ->addArgument('name', InputArgument::OPTIONAL, 'Class name.')
    ->setCode('command')
    ->run();
